name: Test PR Preview Setup

on:
  workflow_dispatch:
  push:
    branches: [ develop ]
    paths: 
      - '.github/workflows/**'

jobs:
  test-setup:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: '10.10.0'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Check Nuxt configuration
      run: |
        echo "Checking if build dependencies are available..."
        pnpm list @nuxt/ui-pro
        pnpm list nuxt

    - name: Validate build setup (without building)
      run: |
        echo "Testing Nuxt prepare step..."
        pnpm run postinstall
        
        echo "Checking output directory structure..."
        if [ ! -d ".nuxt" ]; then
          echo "❌ .nuxt directory not created"
          exit 1
        fi
        
        echo "✅ Basic setup validation passed"
        echo "Note: Full build requires NUXT_UI_PRO_LICENSE secret"

    - name: Check GitHub Pages compatibility
      run: |
        echo "Checking if project is configured for static generation..."
        if grep -q '"generate"' package.json; then
          echo "✅ Generate script found in package.json"
        else
          echo "❌ Generate script not found"
          exit 1
        fi
        
        if grep -q 'ssr: false' nuxt.config.ts; then
          echo "✅ SSR disabled - compatible with static hosting"
        else
          echo "⚠️  SSR might be enabled - check compatibility"
        fi

  test-workflow-syntax:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Validate workflow files
      run: |
        echo "Checking workflow syntax..."
        
        # Check if workflow files exist
        if [ -f ".github/workflows/pr-preview.yml" ]; then
          echo "✅ PR preview workflow found"
        else
          echo "❌ PR preview workflow not found"
          exit 1
        fi
        
        if [ -f ".github/workflows/pr-cleanup.yml" ]; then
          echo "✅ PR cleanup workflow found"
        else
          echo "❌ PR cleanup workflow not found"
          exit 1
        fi
        
        echo "✅ All workflow files present"